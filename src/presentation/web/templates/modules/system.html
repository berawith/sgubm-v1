<style>
    .permissions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .category-section {
        grid-column: 1 / -1;
        margin-top: 30px;
    }

    .category-title {
        font-size: 1rem;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 8px;
    }

    .perm-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-top: 4px solid var(--card-theme-color, #6366f1);
        border-radius: 16px;
        padding: 22px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        flex-direction: column;
        gap: 15px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        position: relative;
        overflow: hidden;
    }

    .perm-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: var(--card-theme-color, #6366f1);
    }

    .perm-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--card-theme-color, #6366f1) 0%, transparent 100%);
        opacity: 0.03;
        pointer-events: none;
    }

    .perm-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .perm-card-header i {
        font-size: 1.5rem;
    }

    .perm-card-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 0.95rem;
    }

    .perm-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .perm-action-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(248, 250, 252, 0.5);
        border-radius: 10px;
        border: 1px solid #f1f5f9;
    }

    .perm-action-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
    }

    .perm-hud-pulse {
        animation: pulse-indigo 2s infinite;
    }

    @keyframes pulse-indigo {
        0% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
        }
    }
</style>

<div id="system-view" class="view content-view" style="display: none;">
    <!-- View Header: Minimalist & Spaced -->
    <div class="view-header">
        <div class="header-left">
            <h1 class="page-title">Sistema</h1>
            <p class="page-subtitle">Gestión de usuarios, perfiles y auditoría general.</p>
        </div>
        <div class="header-actions">
            <button class="btn-premium" id="btn-add-user" onclick="app.modules.users.showUserForm()">
                <i class="fas fa-user-plus"></i> Nuevo Usuario
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" style="margin-bottom: 24px;">
        <div class="stat-card premium-card glass">
            <div class="stat-icon-circle premium-gradient"><i class="fas fa-users"></i></div>
            <div class="stat-content">
                <span class="stat-label">Usuarios</span>
                <span class="stat-value" id="total-users-count">0</span>
            </div>
        </div>

        <div class="stat-card premium-card glass">
            <div class="stat-icon-circle text-success"><i class="fas fa-user-shield"></i></div>
            <div class="stat-content">
                <span class="stat-label">Administradores</span>
                <span class="stat-value" id="admin-users-count">0</span>
            </div>
        </div>

        <div class="stat-card premium-card glass">
            <div class="stat-icon-circle text-warning"><i class="fas fa-user-tag"></i></div>
            <div class="stat-content">
                <span class="stat-label">Cobradores</span>
                <span class="stat-value" id="collector-users-count">0</span>
            </div>
        </div>
    </div>

    <!-- Premium Tab Switcher -->
    <div class="premium-tabs-container"
        style="margin-bottom: 24px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 20px;">
        <button class="premium-tab-btn active" id="tab-btn-users" onclick="app.modules.users.switchTab('users')"
            style="padding: 10px 16px; border: none; background: transparent; font-weight: 600; color: #4f46e5; border-bottom: 3px solid #4f46e5; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-users-cog"></i> Cuentas del Sistema
        </button>
        <button class="premium-tab-btn" id="tab-btn-permissions" onclick="app.modules.users.switchTab('permissions')"
            style="padding: 10px 16px; border: none; background: transparent; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-key"></i> Matriz de Permisos
        </button>
    </div>

    <!-- Contenedor: Usuarios -->
    <div id="tab-users-content" class="system-tab-content">
        <!-- Toolbar Decorativa -->
        <div class="clients-toolbar glass-panel" style="margin-bottom: 20px;">
            <div class="toolbar-group">
                <h3
                    style="margin: 0; font-size: 1.1rem; color: #1e293b; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    Listado de Usuarios
                </h3>
            </div>
            <div class="toolbar-actions">
                <button class="btn-secondary btn-icon" onclick="app.modules.users.load()" title="Recargar">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Tabla Principal Usuarios (Desktop) -->
        <div id="system-users-table-view" class="table-container-premium glass-panel">
            <table class="premium-data-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th width="120">Cédula</th>
                        <th width="200">Nombre Real</th>
                        <th width="130">Rol</th>
                        <th width="130">Zona</th>
                        <th width="160">Router Asignado</th>
                        <th width="150">Último Acceso</th>
                        <th width="120" style="text-align: right;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Injected by users.js -->
                </tbody>
            </table>
        </div>

        <!-- Vista de Tarjetas (Mobile) -->
        <div id="system-users-cards-grid" class="mobile-cards-container" style="display: none;">
            <!-- Injected by users.js -->
        </div>
    </div>

    <!-- Contenedor: Permisos (Oculto por defecto) -->
    <div id="tab-permissions-content" class="system-tab-content" style="display: none;">
        <div class="clients-toolbar glass-panel" style="margin-bottom: 20px;">
            <div class="toolbar-group" style="display: flex; align-items: center; gap: 15px;">
                <h3
                    style="margin: 0; font-size: 1.1rem; color: #1e293b; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    Matriz de Permisos (RBAC)
                </h3>

                <!-- Selector de Rol a Configurar -->
                <div class="search-box premium-input-wrapper" style="width: auto; min-width: 250px;">
                    <i class="fas fa-user-tag search-icon text-primary"></i>
                    <select id="role-selector" class="premium-search-input"
                        style="padding-left: 40px; cursor: pointer; appearance: auto;"
                        onchange="app.modules.users.loadPermissions()">
                        <option value="collector">Rol: Cobrador (Restringido)</option>
                        <option value="tecnico">Rol: Técnico (Operaciones)</option>
                        <option value="secretaria">Rol: Secretaria (Oficina)</option>
                        <option value="socio">Rol: Socio (Lectura/Auditoría)</option>
                        <option value="administradora">Rol: Administradora (Total)</option>
                        <option value="admin">Rol: Administrador (Total)</option>
                    </select>
                </div>
            </div>

            <div class="toolbar-actions">
                <button class="btn-premium primary" onclick="app.modules.users.savePermissions()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>

        <!-- HUD de Resumen Inteligente -->
        <div id="role-summary-hud" class="glass-panel"
            style="margin-bottom: 24px; padding: 20px; display: flex; justify-content: space-around; align-items: center; border-left: 5px solid #6366f1; background: linear-gradient(90deg, rgba(99, 102, 241, 0.05) 0%, rgba(255, 255, 255, 0.8) 100%);">
            <div class="hud-item text-center">
                <span
                    style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">Nivel
                    de Acceso</span>
                <span id="hud-access-level"
                    style="font-size: 1.2rem; font-weight: 800; color: #1e293b;">Cargando...</span>
            </div>
            <div class="hud-divider" style="width: 1px; height: 40px; background: #e2e8f0;"></div>
            <div class="hud-item text-center">
                <span
                    style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">Módulos
                    Visibles</span>
                <span id="hud-visible-modules" style="font-size: 1.2rem; font-weight: 800; color: #6366f1;">0</span>
            </div>
            <div class="hud-divider" style="width: 1px; height: 40px; background: #e2e8f0;"></div>
            <div class="hud-item text-center">
                <span
                    style="display: block; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">Acciones
                    de Riesgo</span>
                <span id="hud-risk-actions"
                    style="font-size: 1.2rem; font-weight: 800; color: #f43f5e;">Desactivadas</span>
            </div>
        </div>

        <!-- Cuadrícula de Permisos Categorizada -->
        <div id="permissions-container" class="permissions-grid">
            <!-- Inyectado dinámicamente por categorías en users.js -->
            <div id="permissions-loading" class="text-center" style="padding: 100px 0;">
                <div class="spinner"></div>
                <p class="mt-3 text-muted">Diseñando interfaz inteligente...</p>
            </div>
        </div>

        <div
            style="margin-top: 15px; padding: 15px; background: rgba(99, 102, 241, 0.05); border-radius: 12px; border: 1px dashed rgba(99, 102, 241, 0.2);">
            <p style="margin: 0; font-size: 0.85rem; color: #64748b;">
                <i class="fas fa-info-circle" style="color: #6366f1; margin-right: 5px;"></i>
                <strong>Nota de Seguridad:</strong> Si desactivas el permiso de <strong>"Ver"</strong> en un módulo,
                este desaparecerá completamente del menú de navegación para los usuarios con ese rol.
            </p>
        </div>
    </div>
</div>